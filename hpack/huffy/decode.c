#include "bitbuf.h"
#include "decode.h"
#include "../number.h"

struct fast_find_symbol {
    uint8_t octet;
    // when bits <= 8, use just this result. otherwise look at next octet.
    uint8_t bits;
};

#define SENTINEL 0xff

// Left-aligned values
// TODO: Keep all the bitlengths in a separate table (keyed by input
// character/octet) that can be used by both encode & decode. Although that
// might be slightly slower.
static const struct fast_find_symbol shortbits0[256] = {
    // 00000 (0x0) [5] = '0' (through 0x07)
    { '0', 5 }, // 00000000
    { '0', 5 }, // 00000001
    { '0', 5 }, // 00000010
    { '0', 5 }, // 00000011
    { '0', 5 }, // 00000100
    { '0', 5 }, // 00000101
    { '0', 5 }, // 00000110
    { '0', 5 }, // 00000111
    // 00001 (0x1) [5] = '1'
    { '1', 5 },
    { '1', 5 },
    { '1', 5 },
    { '1', 5 },
    { '1', 5 },
    { '1', 5 },
    { '1', 5 },
    { '1', 5 },
    // 00010 (0x2) [5] = '2'
    { '2', 5 },
    { '2', 5 },
    { '2', 5 },
    { '2', 5 },
    { '2', 5 },
    { '2', 5 },
    { '2', 5 },
    { '2', 5 },
    // 00011 (0x3) [5] = 'a'
    { 'a', 5 },
    { 'a', 5 },
    { 'a', 5 },
    { 'a', 5 },
    { 'a', 5 },
    { 'a', 5 },
    { 'a', 5 },
    { 'a', 5 },
    // 00100 (0x4) [5] = 'c'
    { 'c', 5 },
    { 'c', 5 },
    { 'c', 5 },
    { 'c', 5 },
    { 'c', 5 },
    { 'c', 5 },
    { 'c', 5 },
    { 'c', 5 },
    // 00101 (0x5) [5] = 'e'
    { 'e', 5 },
    { 'e', 5 },
    { 'e', 5 },
    { 'e', 5 },
    { 'e', 5 },
    { 'e', 5 },
    { 'e', 5 },
    { 'e', 5 },
    // 00110 (0x6) [5] = 'i'
    { 'i', 5 },
    { 'i', 5 },
    { 'i', 5 },
    { 'i', 5 },
    { 'i', 5 },
    { 'i', 5 },
    { 'i', 5 },
    { 'i', 5 },
    // 00111 (0x7) [5] = 'o'
    { 'o', 5 },
    { 'o', 5 },
    { 'o', 5 },
    { 'o', 5 },
    { 'o', 5 },
    { 'o', 5 },
    { 'o', 5 },
    { 'o', 5 },
    // 01000 (0x8) [5] = 's'
    { 's', 5 },
    { 's', 5 },
    { 's', 5 },
    { 's', 5 },
    { 's', 5 },
    { 's', 5 },
    { 's', 5 },
    { 's', 5 },
    // 01001 (0x9) [5] = 't'
    { 't', 5 },
    { 't', 5 },
    { 't', 5 },
    { 't', 5 },
    { 't', 5 },
    { 't', 5 },
    { 't', 5 },
    { 't', 5 },
    // 010100 (0x14) [6] = ' '
    { ' ', 6 }, // 01010000
    { ' ', 6 }, // 01010001
    { ' ', 6 }, // 01010010
    { ' ', 6 }, // 01010011
    // 010101 (0x15) [6] = '%'
    { '%', 6 },
    { '%', 6 },
    { '%', 6 },
    { '%', 6 },
    // 010110 (0x16) [6] = '-'
    { '-', 6 },
    { '-', 6 },
    { '-', 6 },
    { '-', 6 },
    // 010111 (0x17) [6] = '.'
    { '.', 6 },
    { '.', 6 },
    { '.', 6 },
    { '.', 6 },
    // 011000 (0x18) [6] = '/'
    { '/', 6 },
    { '/', 6 },
    { '/', 6 },
    { '/', 6 },
    // 011001 (0x19) [6] = '3'
    { '3', 6 },
    { '3', 6 },
    { '3', 6 },
    { '3', 6 },
    // 011010 (0x1a) [6] = '4'
    { '4', 6 },
    { '4', 6 },
    { '4', 6 },
    { '4', 6 },
    // 011011 (0x1b) [6] = '5'
    { '5', 6 },
    { '5', 6 },
    { '5', 6 },
    { '5', 6 },
    // 011100 (0x1c) [6] = '6'
    { '6', 6 },
    { '6', 6 },
    { '6', 6 },
    { '6', 6 },
    // 011101 (0x1d) [6] = '7'
    { '7', 6 },
    { '7', 6 },
    { '7', 6 },
    { '7', 6 },
    // 011110 (0x1e) [6] = '8'
    { '8', 6 },
    { '8', 6 },
    { '8', 6 },
    { '8', 6 },
    // 011111 (0x1f) [6] = '9'
    { '9', 6 },
    { '9', 6 },
    { '9', 6 },
    { '9', 6 },
    // 100000 (0x20) [6] = '='
    { '=', 6 },
    { '=', 6 },
    { '=', 6 },
    { '=', 6 },
    // 100001 (0x21) [6] = 'A'
    { 'A', 6 },
    { 'A', 6 },
    { 'A', 6 },
    { 'A', 6 },
    // 100010 (0x22) [6] = '_'
    { '_', 6 },
    { '_', 6 },
    { '_', 6 },
    { '_', 6 },
    // 100011 (0x23) [6] = 'b'
    { 'b', 6 },
    { 'b', 6 },
    { 'b', 6 },
    { 'b', 6 },
    // 100100 (0x24) [6] = 'd'
    { 'd', 6 },
    { 'd', 6 },
    { 'd', 6 },
    { 'd', 6 },
    // 100101 (0x25) [6] = 'f'
    { 'f', 6 },
    { 'f', 6 },
    { 'f', 6 },
    { 'f', 6 },
    // 100110 (0x26) [6] = 'g'
    { 'g', 6 },
    { 'g', 6 },
    { 'g', 6 },
    { 'g', 6 },
    // 100111 (0x27) [6] = 'h'
    { 'h', 6 },
    { 'h', 6 },
    { 'h', 6 },
    { 'h', 6 },
    // 101000 (0x28) [6] = 'l'
    { 'l', 6 },
    { 'l', 6 },
    { 'l', 6 },
    { 'l', 6 },
    // 101001 (0x29) [6] = 'm'
    { 'm', 6 },
    { 'm', 6 },
    { 'm', 6 },
    { 'm', 6 },
    // 101010 (0x2a) [6] = 'n'
    { 'n', 6 },
    { 'n', 6 },
    { 'n', 6 },
    { 'n', 6 },
    // 101011 (0x2b) [6] = 'p'
    { 'p', 6 },
    { 'p', 6 },
    { 'p', 6 },
    { 'p', 6 },
    // 101100 (0x2c) [6] = 'r'
    { 'r', 6 },
    { 'r', 6 },
    { 'r', 6 },
    { 'r', 6 },
    // 101101 (0x2d) [6] = 'u'
    { 'u', 6 },
    { 'u', 6 },
    { 'u', 6 },
    { 'u', 6 },
    // 1011100 (0x5c) [7] = ':'
    { ':', 7 },
    { ':', 7 },
    // 1011101 (0x5d) [7] = 'B'
    { 'B', 7 },
    { 'B', 7 },
    { 'C', 7 },
    { 'C', 7 },
    { 'D', 7 },
    { 'D', 7 },
    { 'E', 7 },
    { 'E', 7 },
    { 'F', 7 },
    { 'F', 7 },
    { 'G', 7 },
    { 'G', 7 },
    { 'H', 7 },
    { 'H', 7 },
    { 'I', 7 },
    { 'I', 7 },
    { 'J', 7 },
    { 'J', 7 },
    { 'K', 7 },
    { 'K', 7 },
    { 'L', 7 },
    { 'L', 7 },
    { 'M', 7 },
    { 'M', 7 },
    { 'N', 7 },
    { 'N', 7 },
    { 'O', 7 },
    { 'O', 7 },
    { 'P', 7 },
    { 'P', 7 },
    { 'Q', 7 },
    { 'Q', 7 },
    { 'R', 7 },
    { 'R', 7 },
    { 'S', 7 },
    { 'S', 7 },
    { 'T', 7 },
    { 'T', 7 },
    { 'U', 7 },
    { 'U', 7 },
    { 'V', 7 },
    { 'V', 7 },
    { 'W', 7 },
    { 'W', 7 },
    { 'Y', 7 },
    { 'Y', 7 },
    { 'j', 7 },
    { 'j', 7 },
    { 'k', 7 },
    { 'k', 7 },
    { 'q', 7 },
    { 'q', 7 },
    { 'v', 7 },
    { 'v', 7 },
    { 'w', 7 },
    { 'w', 7 },
    { 'x', 7 },
    { 'x', 7 },
    { 'y', 7 },
    { 'y', 7 },
    { 'z', 7 },
    { 'z', 7 },
    { '&', 8 },
    { '*', 8 },
    { ',', 8 },
    { ';', 8 },
    { 'X', 8 },
    { 'Z', 8 },
    { SENTINEL, SENTINEL }, // 0xfe
    { SENTINEL, SENTINEL }, // 0xff
};

// Lookup table for 2nd octet when first octet was all-ones
static const struct fast_find_symbol shortbits1_ff[256] = {
    // 00 (0x0) [10] = '?' (through 0x07)
    { '?', 10 }, // 00000000
    { '?', 10 }, // 00000001
    { '?', 10 }, // 00000010
    { '?', 10 }, // 00000011
    { '?', 10 }, // 00000100
    { '?', 10 }, // 00000101
    { '?', 10 }, // 00000110
    { '?', 10 }, // 00000111
    { '?', 10 }, // 00001000
    { '?', 10 }, // 00001001
    { '?', 10 }, // 00001010
    { '?', 10 }, // 00001011
    { '?', 10 }, // 00001100
    { '?', 10 }, // 00001101
    { '?', 10 }, // 00001110
    { '?', 10 }, // 00001111
    { '?', 10 }, // 00010000
    { '?', 10 }, // 00010001
    { '?', 10 }, // 00010010
    { '?', 10 }, // 00010011
    { '?', 10 }, // 00010100
    { '?', 10 }, // 00010101
    { '?', 10 }, // 00010110
    { '?', 10 }, // 00010111
    { '?', 10 }, // 00011000
    { '?', 10 }, // 00011001
    { '?', 10 }, // 00011010
    { '?', 10 }, // 00011011
    { '?', 10 }, // 00011100
    { '?', 10 }, // 00011101
    { '?', 10 }, // 00011110
    { '?', 10 }, // 00011111
    { '?', 10 }, // 00100000
    { '?', 10 }, // 00100001
    { '?', 10 }, // 00100010
    { '?', 10 }, // 00100011
    { '?', 10 }, // 00100100
    { '?', 10 }, // 00100101
    { '?', 10 }, // 00100110
    { '?', 10 }, // 00100111
    { '?', 10 }, // 00101000
    { '?', 10 }, // 00101001
    { '?', 10 }, // 00101010
    { '?', 10 }, // 00101011
    { '?', 10 }, // 00101100
    { '?', 10 }, // 00101101
    { '?', 10 }, // 00101110
    { '?', 10 }, // 00101111
    { '?', 10 }, // 00110000
    { '?', 10 }, // 00110001
    { '?', 10 }, // 00110010
    { '?', 10 }, // 00110011
    { '?', 10 }, // 00110100
    { '?', 10 }, // 00110101
    { '?', 10 }, // 00110110
    { '?', 10 }, // 00110111
    { '?', 10 }, // 00111000
    { '?', 10 }, // 00111001
    { '?', 10 }, // 00111010
    { '?', 10 }, // 00111011
    { '?', 10 }, // 00111100
    { '?', 10 }, // 00111101
    { '?', 10 }, // 00111110
    { '?', 10 }, // 00111111
    // 010 (0x02) [11] = '\''
    { '\'', 11 }, // 01000000
    { '\'', 11 }, // 01000001
    { '\'', 11 }, // 01000010
    { '\'', 11 }, // 01000011
    { '\'', 11 }, // 01000100
    { '\'', 11 }, // 01000101
    { '\'', 11 }, // 01000110
    { '\'', 11 }, // 01000111
    { '\'', 11 }, // 01001000
    { '\'', 11 }, // 01001001
    { '\'', 11 }, // 01001010
    { '\'', 11 }, // 01001011
    { '\'', 11 }, // 01001100
    { '\'', 11 }, // 01001101
    { '\'', 11 }, // 01001110
    { '\'', 11 }, // 01001111
    { '\'', 11 }, // 01010000
    { '\'', 11 }, // 01010001
    { '\'', 11 }, // 01010010
    { '\'', 11 }, // 01010011
    { '\'', 11 }, // 01010100
    { '\'', 11 }, // 01010101
    { '\'', 11 }, // 01010110
    { '\'', 11 }, // 01010111
    { '\'', 11 }, // 01011000
    { '\'', 11 }, // 01011001
    { '\'', 11 }, // 01011010
    { '\'', 11 }, // 01011011
    { '\'', 11 }, // 01011100
    { '\'', 11 }, // 01011101
    { '\'', 11 }, // 01011110
    { '\'', 11 }, // 01011111
    // 011 (0x03) [11] = '+'
    { '+', 11 }, // 01100000
    { '+', 11 }, // 01100001
    { '+', 11 }, // 01100010
    { '+', 11 }, // 01100011
    { '+', 11 }, // 01100100
    { '+', 11 }, // 01100101
    { '+', 11 }, // 01100110
    { '+', 11 }, // 01100111
    { '+', 11 }, // 01101000
    { '+', 11 }, // 01101001
    { '+', 11 }, // 01101010
    { '+', 11 }, // 01101011
    { '+', 11 }, // 01101100
    { '+', 11 }, // 01101101
    { '+', 11 }, // 01101110
    { '+', 11 }, // 01101111
    { '+', 11 }, // 01110000
    { '+', 11 }, // 01110001
    { '+', 11 }, // 01110010
    { '+', 11 }, // 01110011
    { '+', 11 }, // 01110100
    { '+', 11 }, // 01110101
    { '+', 11 }, // 01110110
    { '+', 11 }, // 01110111
    { '+', 11 }, // 01111000
    { '+', 11 }, // 01111001
    { '+', 11 }, // 01111010
    { '+', 11 }, // 01111011
    { '+', 11 }, // 01111100
    { '+', 11 }, // 01111101
    { '+', 11 }, // 01111110
    { '+', 11 }, // 01111111
    // 100 (0x04) [11] = '|'
    { '|', 11 }, // 10000000
    { '|', 11 }, // 10000001
    { '|', 11 }, // 10000010
    { '|', 11 }, // 10000011
    { '|', 11 }, // 10000100
    { '|', 11 }, // 10000101
    { '|', 11 }, // 10000110
    { '|', 11 }, // 10000111
    { '|', 11 }, // 10001000
    { '|', 11 }, // 10001001
    { '|', 11 }, // 10001010
    { '|', 11 }, // 10001011
    { '|', 11 }, // 10001100
    { '|', 11 }, // 10001101
    { '|', 11 }, // 10001110
    { '|', 11 }, // 10001111
    { '|', 11 }, // 10010000
    { '|', 11 }, // 10010001
    { '|', 11 }, // 10010010
    { '|', 11 }, // 10010011
    { '|', 11 }, // 10010100
    { '|', 11 }, // 10010101
    { '|', 11 }, // 10010110
    { '|', 11 }, // 10010111
    { '|', 11 }, // 10011000
    { '|', 11 }, // 10011001
    { '|', 11 }, // 10011010
    { '|', 11 }, // 10011011
    { '|', 11 }, // 10011100
    { '|', 11 }, // 10011101
    { '|', 11 }, // 10011110
    { '|', 11 }, // 10011111
    // 1010 (0x0a) [12] = '#'
    { '#', 12 }, // 10100000
    { '#', 12 }, // 10100001
    { '#', 12 }, // 10100010
    { '#', 12 }, // 10100011
    { '#', 12 }, // 10100100
    { '#', 12 }, // 10100101
    { '#', 12 }, // 10100110
    { '#', 12 }, // 10100111
    { '#', 12 }, // 10101000
    { '#', 12 }, // 10101001
    { '#', 12 }, // 10101010
    { '#', 12 }, // 10101011
    { '#', 12 }, // 10101100
    { '#', 12 }, // 10101101
    { '#', 12 }, // 10101110
    { '#', 12 }, // 10101111
    // 1011 (0x0b) [12] = '>'
    { '>', 12 }, // 10110000
    { '>', 12 }, // 10110001
    { '>', 12 }, // 10110010
    { '>', 12 }, // 10110011
    { '>', 12 }, // 10110100
    { '>', 12 }, // 10110101
    { '>', 12 }, // 10110110
    { '>', 12 }, // 10110111
    { '>', 12 }, // 10111000
    { '>', 12 }, // 10111001
    { '>', 12 }, // 10111010
    { '>', 12 }, // 10111011
    { '>', 12 }, // 10111100
    { '>', 12 }, // 10111101
    { '>', 12 }, // 10111110
    { '>', 12 }, // 10111111
    // 11000 [13] = '\0'
    { '\0', 13 }, // 11000000
    { '\0', 13 }, // 11000001
    { '\0', 13 }, // 11000010
    { '\0', 13 }, // 11000011
    { '\0', 13 }, // 11000100
    { '\0', 13 }, // 11000101
    { '\0', 13 }, // 11000110
    { '\0', 13 }, // 11000111
    // 11001 [13] = '$'
    { '$', 13 }, // 11001000
    { '$', 13 }, // 11001001
    { '$', 13 }, // 11001010
    { '$', 13 }, // 11001011
    { '$', 13 }, // 11001100
    { '$', 13 }, // 11001101
    { '$', 13 }, // 11001110
    { '$', 13 }, // 11001111
    // 11010 [13] = '@'
    { '@', 13 }, // 11010000
    { '@', 13 }, // 11010001
    { '@', 13 }, // 11010010
    { '@', 13 }, // 11010011
    { '@', 13 }, // 11010100
    { '@', 13 }, // 11010101
    { '@', 13 }, // 11010110
    { '@', 13 }, // 11010111
    // 11011 [13] = '['
    { '[', 13 }, // 11011000
    { '[', 13 }, // 11011001
    { '[', 13 }, // 11011010
    { '[', 13 }, // 11011011
    { '[', 13 }, // 11011100
    { '[', 13 }, // 11011101
    { '[', 13 }, // 11011110
    { '[', 13 }, // 11011111
    // 11100 [13] = ']'
    { ']', 13 }, // 11100000
    { ']', 13 }, // 11100001
    { ']', 13 }, // 11100010
    { ']', 13 }, // 11100011
    { ']', 13 }, // 11100100
    { ']', 13 }, // 11100101
    { ']', 13 }, // 11100110
    { ']', 13 }, // 11100111
    // 11101 [13] = '~'
    { '~', 13 }, // 11101000
    { '~', 13 }, // 11101001
    { '~', 13 }, // 11101010
    { '~', 13 }, // 11101011
    { '~', 13 }, // 11101100
    { '~', 13 }, // 11101101
    { '~', 13 }, // 11101110
    { '~', 13 }, // 11101111
    // 111100 [14] = '^'
    { '^', 14 }, // 11110000
    { '^', 14 }, // 11110001
    { '^', 14 }, // 11110010
    { '^', 14 }, // 11110011
    // 111101 [14] = '}'
    { '}', 14 }, // 11110100
    { '}', 14 }, // 11110101
    { '}', 14 }, // 11110110
    { '}', 14 }, // 11110111
    // 1111100 [15] = '<'
    { '<', 15 }, // 11111000
    { '<', 15 }, // 11111001
    // 1111101 [15] = '`'
    { '`', 15 }, // 11111010
    { '`', 15 }, // 11111011
    // 1111110 [15] = '{'
    { '{', 15 }, // 11111100
    { '{', 15 }, // 11111101
    { SENTINEL, SENTINEL }, // 11111110
    { SENTINEL, SENTINEL }, // 11111111
};

// only 15 symbols in the 0xfffe prefix
static const struct fast_find_symbol shortbits2_fffe[256] = {
    // 000 (0x00) [3] = '\\'
    { '\\', 19 }, // 00000000
    { '\\', 19 }, // 00000001
    { '\\', 19 }, // 00000010
    { '\\', 19 }, // 00000011
    { '\\', 19 }, // 00000100
    { '\\', 19 }, // 00000101
    { '\\', 19 }, // 00000110
    { '\\', 19 }, // 00000111
    { '\\', 19 }, // 00001000
    { '\\', 19 }, // 00001001
    { '\\', 19 }, // 00001010
    { '\\', 19 }, // 00001011
    { '\\', 19 }, // 00001100
    { '\\', 19 }, // 00001101
    { '\\', 19 }, // 00001110
    { '\\', 19 }, // 00001111
    { '\\', 19 }, // 00010000
    { '\\', 19 }, // 00010001
    { '\\', 19 }, // 00010010
    { '\\', 19 }, // 00010011
    { '\\', 19 }, // 00010100
    { '\\', 19 }, // 00010101
    { '\\', 19 }, // 00010110
    { '\\', 19 }, // 00010111
    { '\\', 19 }, // 00011000
    { '\\', 19 }, // 00011001
    { '\\', 19 }, // 00011010
    { '\\', 19 }, // 00011011
    { '\\', 19 }, // 00011100
    { '\\', 19 }, // 00011101
    { '\\', 19 }, // 00011110
    { '\\', 19 }, // 00011111
    // 001 (0x01) [19] = '\xc3' (195)
    { '\xc3', 19 }, // 00100000
    { '\xc3', 19 }, // 00100001
    { '\xc3', 19 }, // 00100010
    { '\xc3', 19 }, // 00100011
    { '\xc3', 19 }, // 00100100
    { '\xc3', 19 }, // 00100101
    { '\xc3', 19 }, // 00100110
    { '\xc3', 19 }, // 00100111
    { '\xc3', 19 }, // 00101000
    { '\xc3', 19 }, // 00101001
    { '\xc3', 19 }, // 00101010
    { '\xc3', 19 }, // 00101011
    { '\xc3', 19 }, // 00101100
    { '\xc3', 19 }, // 00101101
    { '\xc3', 19 }, // 00101110
    { '\xc3', 19 }, // 00101111
    { '\xc3', 19 }, // 00110000
    { '\xc3', 19 }, // 00110001
    { '\xc3', 19 }, // 00110010
    { '\xc3', 19 }, // 00110011
    { '\xc3', 19 }, // 00110100
    { '\xc3', 19 }, // 00110101
    { '\xc3', 19 }, // 00110110
    { '\xc3', 19 }, // 00110111
    { '\xc3', 19 }, // 00111000
    { '\xc3', 19 }, // 00111001
    { '\xc3', 19 }, // 00111010
    { '\xc3', 19 }, // 00111011
    { '\xc3', 19 }, // 00111100
    { '\xc3', 19 }, // 00111101
    { '\xc3', 19 }, // 00111110
    { '\xc3', 19 }, // 00111111
    // 010 [19] = '\xd0' (208)
    { '\xd0', 19 }, // 01000000
    { '\xd0', 19 }, // 01000001
    { '\xd0', 19 }, // 01000010
    { '\xd0', 19 }, // 01000011
    { '\xd0', 19 }, // 01000100
    { '\xd0', 19 }, // 01000101
    { '\xd0', 19 }, // 01000110
    { '\xd0', 19 }, // 01000111
    { '\xd0', 19 }, // 01001000
    { '\xd0', 19 }, // 01001001
    { '\xd0', 19 }, // 01001010
    { '\xd0', 19 }, // 01001011
    { '\xd0', 19 }, // 01001100
    { '\xd0', 19 }, // 01001101
    { '\xd0', 19 }, // 01001110
    { '\xd0', 19 }, // 01001111
    { '\xd0', 19 }, // 01010000
    { '\xd0', 19 }, // 01010001
    { '\xd0', 19 }, // 01010010
    { '\xd0', 19 }, // 01010011
    { '\xd0', 19 }, // 01010100
    { '\xd0', 19 }, // 01010101
    { '\xd0', 19 }, // 01010110
    { '\xd0', 19 }, // 01010111
    { '\xd0', 19 }, // 01011000
    { '\xd0', 19 }, // 01011001
    { '\xd0', 19 }, // 01011010
    { '\xd0', 19 }, // 01011011
    { '\xd0', 19 }, // 01011100
    { '\xd0', 19 }, // 01011101
    { '\xd0', 19 }, // 01011110
    { '\xd0', 19 }, // 01011111
    // 0110 [20] = '\x80' (128)
    { '\x80', 20 }, // 01100000
    { '\x80', 20 }, // 01100001
    { '\x80', 20 }, // 01100010
    { '\x80', 20 }, // 01100011
    { '\x80', 20 }, // 01100100
    { '\x80', 20 }, // 01100101
    { '\x80', 20 }, // 01100110
    { '\x80', 20 }, // 01100111
    { '\x80', 20 }, // 01101000
    { '\x80', 20 }, // 01101001
    { '\x80', 20 }, // 01101010
    { '\x80', 20 }, // 01101011
    { '\x80', 20 }, // 01101100
    { '\x80', 20 }, // 01101101
    { '\x80', 20 }, // 01101110
    { '\x80', 20 }, // 01101111
    // 0111 [20] = '\x82' (130)
    { '\x82', 20 }, // 01110000
    { '\x82', 20 }, // 01110001
    { '\x82', 20 }, // 01110010
    { '\x82', 20 }, // 01110011
    { '\x82', 20 }, // 01110100
    { '\x82', 20 }, // 01110101
    { '\x82', 20 }, // 01110110
    { '\x82', 20 }, // 01110111
    { '\x82', 20 }, // 01111000
    { '\x82', 20 }, // 01111001
    { '\x82', 20 }, // 01111010
    { '\x82', 20 }, // 01111011
    { '\x82', 20 }, // 01111100
    { '\x82', 20 }, // 01111101
    { '\x82', 20 }, // 01111110
    { '\x82', 20 }, // 01111111
    // 1000 [20] = '\x83' (131)
    { '\x83', 20 }, // 10000000
    { '\x83', 20 }, // 10000001
    { '\x83', 20 }, // 10000010
    { '\x83', 20 }, // 10000011
    { '\x83', 20 }, // 10000100
    { '\x83', 20 }, // 10000101
    { '\x83', 20 }, // 10000110
    { '\x83', 20 }, // 10000111
    { '\x83', 20 }, // 10001000
    { '\x83', 20 }, // 10001001
    { '\x83', 20 }, // 10001010
    { '\x83', 20 }, // 10001011
    { '\x83', 20 }, // 10001100
    { '\x83', 20 }, // 10001101
    { '\x83', 20 }, // 10001110
    { '\x83', 20 }, // 10001111
    // 1001 [20] = '\xa2' (162)
    { '\xa2', 20 }, // 10010000
    { '\xa2', 20 }, // 10010001
    { '\xa2', 20 }, // 10010010
    { '\xa2', 20 }, // 10010011
    { '\xa2', 20 }, // 10010100
    { '\xa2', 20 }, // 10010101
    { '\xa2', 20 }, // 10010110
    { '\xa2', 20 }, // 10010111
    { '\xa2', 20 }, // 10011000
    { '\xa2', 20 }, // 10011001
    { '\xa2', 20 }, // 10011010
    { '\xa2', 20 }, // 10011011
    { '\xa2', 20 }, // 10011100
    { '\xa2', 20 }, // 10011101
    { '\xa2', 20 }, // 10011110
    { '\xa2', 20 }, // 10011111
    // 1010 [20] = '\xb8' (184)
    { '\xb8', 20 }, // 10100000
    { '\xb8', 20 }, // 10100001
    { '\xb8', 20 }, // 10100010
    { '\xb8', 20 }, // 10100011
    { '\xb8', 20 }, // 10100100
    { '\xb8', 20 }, // 10100101
    { '\xb8', 20 }, // 10100110
    { '\xb8', 20 }, // 10100111
    { '\xb8', 20 }, // 10101000
    { '\xb8', 20 }, // 10101001
    { '\xb8', 20 }, // 10101010
    { '\xb8', 20 }, // 10101011
    { '\xb8', 20 }, // 10101100
    { '\xb8', 20 }, // 10101101
    { '\xb8', 20 }, // 10101110
    { '\xb8', 20 }, // 10101111
    // 1011 [20] = '\xc2' (194)
    { '\xc2', 20 }, // 10110000
    { '\xc2', 20 }, // 10110001
    { '\xc2', 20 }, // 10110010
    { '\xc2', 20 }, // 10110011
    { '\xc2', 20 }, // 10110100
    { '\xc2', 20 }, // 10110101
    { '\xc2', 20 }, // 10110110
    { '\xc2', 20 }, // 10110111
    { '\xc2', 20 }, // 10111000
    { '\xc2', 20 }, // 10111001
    { '\xc2', 20 }, // 10111010
    { '\xc2', 20 }, // 10111011
    { '\xc2', 20 }, // 10111100
    { '\xc2', 20 }, // 10111101
    { '\xc2', 20 }, // 10111110
    { '\xc2', 20 }, // 10111111
    // 1100 [20] = (224) '\xe0'
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    { '\xe0', 20 },
    // 1101 [20] = (226) '\xe2'
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    { '\xe2', 20 },
    // 11100
    { 0x99, 21 },
    { 0x99, 21 },
    { 0x99, 21 },
    { 0x99, 21 },
    { 0x99, 21 },
    { 0x99, 21 },
    { 0x99, 21 },
    { 0x99, 21 },
    // 11101 (161)
    { 0xa1, 21 },
    { 0xa1, 21 },
    { 0xa1, 21 },
    { 0xa1, 21 },
    { 0xa1, 21 },
    { 0xa1, 21 },
    { 0xa1, 21 },
    { 0xa1, 21 },
    // 11110 (167)
    { 0xa7, 21 },
    { 0xa7, 21 },
    { 0xa7, 21 },
    { 0xa7, 21 },
    { 0xa7, 21 },
    { 0xa7, 21 },
    { 0xa7, 21 },
    { 0xa7, 21 },
    // 11111 (172)
    { 0xac, 21 },
    { 0xac, 21 },
    { 0xac, 21 },
    { 0xac, 21 },
    { 0xac, 21 },
    { 0xac, 21 },
    { 0xac, 21 },
    { 0xac, 21 },
};

static const struct fast_find_symbol shortbits2_ffff[256] = {
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb0, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb1, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    { 0xb3, 21 },
    // 00011 (209)
    { 0xd1, 21 },
    { 0xd1, 21 },
    { 0xd1, 21 },
    { 0xd1, 21 },
    { 0xd1, 21 },
    { 0xd1, 21 },
    { 0xd1, 21 },
    { 0xd1, 21 },
    // 00100 (216)
    { 0xd8, 21 },
    { 0xd8, 21 },
    { 0xd8, 21 },
    { 0xd8, 21 },
    { 0xd8, 21 },
    { 0xd8, 21 },
    { 0xd8, 21 },
    { 0xd8, 21 },
    // 00101 (217)
    { 0xd9, 21 },
    { 0xd9, 21 },
    { 0xd9, 21 },
    { 0xd9, 21 },
    { 0xd9, 21 },
    { 0xd9, 21 },
    { 0xd9, 21 },
    { 0xd9, 21 },
    // 00110 (227)
    { 0xe3, 21 },
    { 0xe3, 21 },
    { 0xe3, 21 },
    { 0xe3, 21 },
    { 0xe3, 21 },
    { 0xe3, 21 },
    { 0xe3, 21 },
    { 0xe3, 21 },
    // 00111 (229)
    { 0xe5, 21 },
    { 0xe5, 21 },
    { 0xe5, 21 },
    { 0xe5, 21 },
    { 0xe5, 21 },
    { 0xe5, 21 },
    { 0xe5, 21 },
    { 0xe5, 21 },
    // 01000 (230)
    { 0xe6, 21 },
    { 0xe6, 21 },
    { 0xe6, 21 },
    { 0xe6, 21 },
    { 0xe6, 21 },
    { 0xe6, 21 },
    { 0xe6, 21 },
    { 0xe6, 21 },
    // 010010 (129) [22]
    { 0x81, 22 },
    { 0x81, 22 },
    { 0x81, 22 },
    { 0x81, 22 },
    // 010011 (132) [22]
    { 0x84, 22 },
    { 0x84, 22 },
    { 0x84, 22 },
    { 0x84, 22 },
    // 010100 [22] (133)
    { 0x85, 22 },
    { 0x85, 22 },
    { 0x85, 22 },
    { 0x85, 22 },
    // 010101 [22] (134)
    { 0x86, 22 },
    { 0x86, 22 },
    { 0x86, 22 },
    { 0x86, 22 },
    // 010110 [22] (136)
    { 0x88, 22 },
    { 0x88, 22 },
    { 0x88, 22 },
    { 0x88, 22 },
    // 010111 [22] (146)
    { 0x92, 22 },
    { 0x92, 22 },
    { 0x92, 22 },
    { 0x92, 22 },
    // 011000 [22] (154)
    { 0x9a, 22 },
    { 0x9a, 22 },
    { 0x9a, 22 },
    { 0x9a, 22 },
    // 011001 [22] (156)
    { 0x9c, 22 },
    { 0x9c, 22 },
    { 0x9c, 22 },
    { 0x9c, 22 },
    // 011010 [22] (160)
    { 0xa0, 22 },
    { 0xa0, 22 },
    { 0xa0, 22 },
    { 0xa0, 22 },
    // 011011 [22] (163)
    { 0xa3, 22 },
    { 0xa3, 22 },
    { 0xa3, 22 },
    { 0xa3, 22 },
    // 011100 [22] (164)
    { 0xa4, 22 },
    { 0xa4, 22 },
    { 0xa4, 22 },
    { 0xa4, 22 },
    // 011101 [22] (169)
    { 0xa9, 22 },
    { 0xa9, 22 },
    { 0xa9, 22 },
    { 0xa9, 22 },
    // 011110 [22] (170)
    { 0xaa, 22 },
    { 0xaa, 22 },
    { 0xaa, 22 },
    { 0xaa, 22 },
    // 011111 [22] (173)
    { 0xad, 22 },
    { 0xad, 22 },
    { 0xad, 22 },
    { 0xad, 22 },
    // 100000 [22] (178)
    { 0xb2, 22 },
    { 0xb2, 22 },
    { 0xb2, 22 },
    { 0xb2, 22 },
    // 100001 [22] (181)
    { 0xb5, 22 },
    { 0xb5, 22 },
    { 0xb5, 22 },
    { 0xb5, 22 },
    // 100010 [22] (185)
    { 0xb9, 22 },
    { 0xb9, 22 },
    { 0xb9, 22 },
    { 0xb9, 22 },
    // 100011 [22] (186)
    { 0xba, 22 },
    { 0xba, 22 },
    { 0xba, 22 },
    { 0xba, 22 },
    // 100100 [22] (187)
    { 0xbb, 22 },
    { 0xbb, 22 },
    { 0xbb, 22 },
    { 0xbb, 22 },
    // 100101 [22] (189)
    { 0xbd, 22 },
    { 0xbd, 22 },
    { 0xbd, 22 },
    { 0xbd, 22 },
    // 100110 [22] (190)
    { 0xbe, 22 },
    { 0xbe, 22 },
    { 0xbe, 22 },
    { 0xbe, 22 },
    // 100111 [22] (196)
    { 0xc4, 22 },
    { 0xc4, 22 },
    { 0xc4, 22 },
    { 0xc4, 22 },
    // 101000 [22] (198)
    { 0xc6, 22 },
    { 0xc6, 22 },
    { 0xc6, 22 },
    { 0xc6, 22 },
    // 101001 [22] (228)
    { 0xe4, 22 },
    { 0xe4, 22 },
    { 0xe4, 22 },
    { 0xe4, 22 },
    // 101010 [22] (232)
    { 0xe8, 22 },
    { 0xe8, 22 },
    { 0xe8, 22 },
    { 0xe8, 22 },
    // 101011 [22] (233)
    { 0xe9, 22 }, // 10101100
    { 0xe9, 22 }, // 10101101
    { 0xe9, 22 }, // 10101110
    { 0xe9, 22 }, // 10101111
    // 1011000 [23] (1)
    { 0x01, 23 },
    { 0x01, 23 },
    // 1011001 [23] (135)
    { 0x87, 23 },
    { 0x87, 23 },
    // 1011010 [23] (137)
    { 0x89, 23 },
    { 0x89, 23 },
    // 1011011 [23] (138)
    { 0x8a, 23 },
    { 0x8a, 23 },
    // 1011100 [23] (139)
    { 0x8b, 23 },
    { 0x8b, 23 },
    // 1011101 [23] (140)
    { 0x8c, 23 },
    { 0x8c, 23 },
    // 1011110 [23] (141)
    { 0x8d, 23 },
    { 0x8d, 23 },
    // 1011111 [23] (143)
    { 0x8f, 23 },
    { 0x8f, 23 },
    // 1100000 [23] (147)
    { 0x93, 23 },
    { 0x93, 23 },
    // 1100001 [23] (149)
    { 0x95, 23 },
    { 0x95, 23 },
    // 1100010 [23] (150)
    { 0x96, 23 },
    { 0x96, 23 },
    // 1100011 [23] (151)
    { 0x97, 23 },
    { 0x97, 23 },
    // 1100100 [23] (152)
    { 0x98, 23 },
    { 0x98, 23 },
    // 1100101 [23] (155)
    { 0x9b, 23 },
    { 0x9b, 23 },
    // 1100110 [23] (157)
    { 0x9d, 23 },
    { 0x9d, 23 },
    // 1100111 [23] (158)
    { 0x9e, 23 },
    { 0x9e, 23 },
    // 1101000 [23] (165)
    { 0xa5, 23 },
    { 0xa5, 23 },
    // 1101001 [23] (166)
    { 0xa6, 23 },
    { 0xa6, 23 },
    // 1101010 [23] (168)
    { 0xa8, 23 },
    { 0xa8, 23 },
    // 1101011 [23] (174)
    { 0xae, 23 },
    { 0xae, 23 },
    // 1101100 [23] (175)
    { 0xaf, 23 },
    { 0xaf, 23 },
    // 1101101 [23] (180)
    { 0xb4, 23 },
    { 0xb4, 23 },
    // 1101110 [23] (182)
    { 0xb6, 23 },
    { 0xb6, 23 },
    // 1101111 [23] (183)
    { 0xb7, 23 },
    { 0xb7, 23 },
    // 1110000 [23] (188)
    { 0xbc, 23 },
    { 0xbc, 23 },
    // 1110001 [23] (191)
    { 0xbf, 23 },
    { 0xbf, 23 },
    // 1110010 [23] (197)
    { 0xc5, 23 },
    { 0xc5, 23 },
    // 1110011 [23] (231)
    { 0xe7, 23 },
    { 0xe7, 23 },
    // 1110100 [23] (239)
    { 0xef, 23 },
    { 0xef, 23 },
    // 11101010 [24] (9)
    { 0x09, 24 },
    // 11101011 [24] (142)
    { 0x8e, 24 },
    // 11101100 [24] (144)
    { 0x90, 24 },
    // 11101101 [24] (145)
    { 0x91, 24 },
    // 11101110 [24] (148)
    { 0x94, 24 },
    // 11101111 [24] (159)
    { 0x9f, 24 },
    // 11110000 [24] (171)
    { 0xab, 24 },
    // 11110001 [24] (206)
    { 0xce, 24 },
    // 11110010 [24] (215)
    { 0xd7, 24 },
    // 11110011 [24] (225)
    { 0xe1, 24 },
    // 11110100 [24] (236)
    { 0xec, 24 },
    // 11110101 [24] (237)
    { 0xed, 24 },

    // The remaining SENTINELs trigger a lookup in either
    // shortbits23 or shortbits3. Inputs 0xfe & 0xff use shortbits3,
    // the rest use shortbits23.

    // 11110110 CONTINUE: 0 -> 199 [25]; 1 -> 207 [25]
    { SENTINEL, SENTINEL },
    // 11110111 CONTINUE: 0 -> 234 [25]; 1 -> 235 [25]
    { SENTINEL, SENTINEL },
    // 11111000 CONTINUE: 00 -> 192 [26]; 01 -> 193 [26]; 10 -> 200 [26]; 11 -> 201 [26]
    { SENTINEL, SENTINEL },
    // 11111001 CONTINUE: {4} [26]
    { SENTINEL, SENTINEL },
    // 11111010 CONTINUE: {4} [26]
    { SENTINEL, SENTINEL },
    // 11111011 CONTINUE: {4} [26]
    { SENTINEL, SENTINEL },
    // 11111100 CONTINUE: {8} [27]
    { SENTINEL, SENTINEL },
    // 11111101 CONTINUE: {8} [27]
    { SENTINEL, SENTINEL },
    // 11111110 CONTINUE: 000 -> 254 [27]; {14} [28] ((only a nibble))
    { SENTINEL, SENTINEL }, // use shortbits3
    // 11111111 CONTINUE: {19} [28,30]
    { SENTINEL, SENTINEL }, // use shortbits3
};

// This table operates on the low 4 bits from octet[2]
// and the high 4 bits from octet[3], ie.
//   uint8_t octet = input[2] << 4 | input[3] >> 4
// This table is NOT for use when input[2] is 0xff or 0xfe,
// see shortbits3 for that.
// This table is shorter than 256 elements because the fe/ff table
// is used for the last values instead.
#define INVALID23 0x00
static const struct fast_find_symbol shortbits23[224] = {
    // First real value in this table is 01100000 (96)
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    { INVALID23, INVALID23 },
    // 01100[000] [25] (199)
    { 0xc7, 25 },
    { 0xc7, 25 },
    { 0xc7, 25 },
    { 0xc7, 25 },
    { 0xc7, 25 },
    { 0xc7, 25 },
    { 0xc7, 25 },
    { 0xc7, 25 },
    // 01101[000] [25] (207)
    { 0xcf, 25 },
    { 0xcf, 25 },
    { 0xcf, 25 },
    { 0xcf, 25 },
    { 0xcf, 25 },
    { 0xcf, 25 },
    { 0xcf, 25 },
    { 0xcf, 25 },
    // 01110[000] [25] (234)
    { 0xea, 25 },
    { 0xea, 25 },
    { 0xea, 25 },
    { 0xea, 25 },
    { 0xea, 25 },
    { 0xea, 25 },
    { 0xea, 25 },
    { 0xea, 25 },
    // 01111[000] [25] (235)
    { 0xeb, 25 },
    { 0xeb, 25 },
    { 0xeb, 25 },
    { 0xeb, 25 },
    { 0xeb, 25 },
    { 0xeb, 25 },
    { 0xeb, 25 },
    { 0xeb, 25 },
    // 100000 [26] (192)
    { 0xc0, 26 },
    { 0xc0, 26 },
    { 0xc0, 26 },
    { 0xc0, 26 },
    // 100001 [26] (193)
    { 0xc1, 26 },
    { 0xc1, 26 },
    { 0xc1, 26 },
    { 0xc1, 26 },
    // 100010 [26] (200)
    { 0xc8, 26 },
    { 0xc8, 26 },
    { 0xc8, 26 },
    { 0xc8, 26 },
    // 100011 [26] (201)
    { 0xc9, 26 },
    { 0xc9, 26 },
    { 0xc9, 26 },
    { 0xc9, 26 },
    // 100100 [26] (202)
    { 0xca, 26 },
    { 0xca, 26 },
    { 0xca, 26 },
    { 0xca, 26 },
    // 100101 [26] (205)
    { 0xcd, 26 },
    { 0xcd, 26 },
    { 0xcd, 26 },
    { 0xcd, 26 },
    // 100110 [26] (210)
    { 0xd2, 26 },
    { 0xd2, 26 },
    { 0xd2, 26 },
    { 0xd2, 26 },
    // 100111 [26] (213)
    { 0xd5, 26 },
    { 0xd5, 26 },
    { 0xd5, 26 },
    { 0xd5, 26 },
    // 101000 [26] (218)
    { 0xda, 26 },
    { 0xda, 26 },
    { 0xda, 26 },
    { 0xda, 26 },
    // 101001 [26] (219)
    { 0xdb, 26 },
    { 0xdb, 26 },
    { 0xdb, 26 },
    { 0xdb, 26 },
    // 101010 [26] (238)
    { 0xee, 26 },
    { 0xee, 26 },
    { 0xee, 26 },
    { 0xee, 26 },
    // 101011 [26] (240)
    { 0xf0, 26 },
    { 0xf0, 26 },
    { 0xf0, 26 },
    { 0xf0, 26 },
    // 101100 [26] (242)
    { 0xf2, 26 },
    { 0xf2, 26 },
    { 0xf2, 26 },
    { 0xf2, 26 },
    // 101101 [26] (243)
    { 0xf3, 26 },
    { 0xf3, 26 },
    { 0xf3, 26 },
    { 0xf3, 26 },
    // 101110 [26] (255) // Caution: same value as SENTINEL
    { 0xff, 26 },
    { 0xff, 26 },
    { 0xff, 26 },
    { 0xff, 26 },
    // 1011110 [27] (203)
    { 203, 27 },
    { 203, 27 },
    // 1011111 [27] (204)
    { 204, 27 },
    { 204, 27 },
    // 1100000 [27] (211)
    { 0xd3, 27 },
    { 0xd3, 27 },
    // 1100001 [27] (212)
    { 0xd4, 27 },
    { 0xd4, 27 },
    // 1100010 [27] (214)
    { 0xd6, 27 },
    { 0xd6, 27 },
    // 1100011 [27] (221)
    { 0xdd, 27 },
    { 0xdd, 27 },
    // 1100100 [27] (222)
    { 0xde, 27 },
    { 0xde, 27 },
    // 1100101 [27] (223)
    { 0xdf, 27 },
    { 0xdf, 27 },
    // 1100110 [27] (241)
    { 0xf1, 27 },
    { 0xf1, 27 },
    // 1100111 [27] (244)
    { 0xf4, 27 },
    { 0xf4, 27 },
    // 1101000 [27] (245)
    { 0xf5, 27 },
    { 0xf5, 27 },
    // 1101001 [27] (246)
    { 0xf6, 27 },
    { 0xf6, 27 },
    // 1101010 [27] (247)
    { 0xf7, 27 },
    { 0xf7, 27 },
    // 1101011 [27] (248)
    { 0xf8, 27 },
    { 0xf8, 27 },
    // 1101100 [27] (250)
    { 0xfa, 27 },
    { 0xfa, 27 },
    // 1101101 [27] (251)
    { 0xfb, 27 },
    { 0xfb, 27 },
    // 1101110 [27] (252)
    { 0xfc, 27 },
    { 0xfc, 27 },
    // 1101111 [27] (253)
    { 0xfd, 27 },
    { 0xfd, 27 },
// Values from here shall be found in the fe/ff table instead.
    // 1110000 [27] (254)
    // 11100010 [28] (2)
    // 11100011 [28] (3)
    // 11100100 [28] (4)
    // 11100101 [28] (5)
    // 11100110 [28] (6)
    // 11100111 [28] (7)
    // 11101000 [28] (8)
    // 11101001 [28] (11)
    // 11101010 [28] (12)
    // 11101011 [28] (14)
    // 11101100 [28] (15)
    // 11101101 [28] (16)
    // 11101110 [28] (17)
    // 11101111 [28] (18)
};

// This table is for the last two sentinels in the shortbits2_ffff table;
// symbols 0xfffffe & 0xffffff.
// Since there are only two branches (ff & fe) with at most
// 6 trailing bits each, we cram them into a shorter table
// (because they are likely to be rare so better to save some
// space at the expense of a tiny bit more compute for the shift).
// ie. The input to this table is
//   uint8_t octet = ((input[3] << 6) & 64) | (input[4] >> 2)
// Those whose length is <=28 could be found in the shortbits23
// table instead, but they're not.
static const struct fast_find_symbol shortbits3[128] = {
    // 0|000,000 [27]
    { 254, 27 },
    { 254, 27 },
    { 254, 27 },
    { 254, 27 },
    { 254, 27 },
    { 254, 27 },
    { 254, 27 },
    { 254, 27 },
    // 0|0010,00 [28]
    { 2, 28 },
    { 2, 28 },
    { 2, 28 },
    { 2, 28 },
    { 3, 28 },
    { 3, 28 },
    { 3, 28 },
    { 3, 28 },
    { 4, 28 },
    { 4, 28 },
    { 4, 28 },
    { 4, 28 },
    { 5, 28 },
    { 5, 28 },
    { 5, 28 },
    { 5, 28 },
    { 6, 28 },
    { 6, 28 },
    { 6, 28 },
    { 6, 28 },
    { 7, 28 },
    { 7, 28 },
    { 7, 28 },
    { 7, 28 },
    { 8, 28 },
    { 8, 28 },
    { 8, 28 },
    { 8, 28 },
    { 11, 28 },
    { 11, 28 },
    { 11, 28 },
    { 11, 28 },
    { 12, 28 },
    { 12, 28 },
    { 12, 28 },
    { 12, 28 },
    { 14, 28 },
    { 14, 28 },
    { 14, 28 },
    { 14, 28 },
    { 15, 28 },
    { 15, 28 },
    { 15, 28 },
    { 15, 28 },
    { 16, 28 },
    { 16, 28 },
    { 16, 28 },
    { 16, 28 },
    { 17, 28 },
    { 17, 28 },
    { 17, 28 },
    { 17, 28 },
    { 18, 28 },
    { 18, 28 },
    { 18, 28 },
    { 18, 28 },
    // 1|0000,00 (or: ff prefix)
    { 19, 28 },
    { 19, 28 },
    { 19, 28 },
    { 19, 28 },
    { 20, 28 },
    { 20, 28 },
    { 20, 28 },
    { 20, 28 },
    { 21, 28 },
    { 21, 28 },
    { 21, 28 },
    { 21, 28 },
    { 23, 28 },
    { 23, 28 },
    { 23, 28 },
    { 23, 28 },
    { 24, 28 },
    { 24, 28 },
    { 24, 28 },
    { 24, 28 },
    { 25, 28 },
    { 25, 28 },
    { 25, 28 },
    { 25, 28 },
    { 26, 28 },
    { 26, 28 },
    { 26, 28 },
    { 26, 28 },
    { 27, 28 },
    { 27, 28 },
    { 27, 28 },
    { 27, 28 },
    { 28, 28 },
    { 28, 28 },
    { 28, 28 },
    { 28, 28 },
    { 29, 28 },
    { 29, 28 },
    { 29, 28 },
    { 29, 28 },
    { 30, 28 },
    { 30, 28 },
    { 30, 28 },
    { 30, 28 },
    { 31, 28 },
    { 31, 28 },
    { 31, 28 },
    { 31, 28 },
    { 127, 28 },
    { 127, 28 },
    { 127, 28 },
    { 127, 28 },
    { 220, 28 },
    { 220, 28 },
    { 220, 28 },
    { 220, 28 },
    { 249, 28 },
    { 249, 28 },
    { 249, 28 },
    { 249, 28 },
    // 1|111100
    { 10, 30 },
    { 13, 30 },
    { 22, 30 },
    // 1|111111 = EOS
    { SENTINEL, SENTINEL }, // EOS, this is valid.
};

#ifndef LIKELY
# define LIKELY(x) __builtin_expect(x, 1)
#endif
#ifndef UNLIKELY
# define UNLIKELY(x) __builtin_expect(x, 0)
#endif

// Protip: The maximum decoded size of an input buffer is
// eight-fifths of the encoded input length.

// first_octet_bits must be [1-8]
// XXX: first_octet_bits is always 8 in HPACK.
// The returned length is the length of the *decoded* string.
// This is weird and surprising.
// But in HPACK all strings are length-prefixed, so you already knew how long
// the input was anyway.
// XXX: Maybe change the API to return the used length; take destlen as a
// pointer that is updated to the actual length of the decoded content.
// Then we'd also need to keep track of how many octets were actually used in
// order to return that info.
ssize_t huffman_decode(
        const uint8_t *buf,
        size_t buflen,
        uint8_t first_octet_bits,
        uint8_t *dest,
        size_t destlen)
{
    if (UNLIKELY(!buf || !dest || first_octet_bits < 1 || first_octet_bits > 8))
        return -3;

    struct bb_reader reader;

    bb_reader_init(&reader, buf, buflen);

    if (UNLIKELY(first_octet_bits != 8))
        bb_next(&reader, 8 - first_octet_bits);

    uint8_t *const begin = dest;
    uint8_t *const end = dest + destlen;

    // TODO: It's probably faster to have an explicit end-of-input check on
    // the bb_reader than to have it return ffs when the end of the input is
    // reached. That way the branches between each table can be annotated to
    // prefer the short branch (terminating in that table).
    // As it stands, end-of-input requires traversing the deepest branch to its
    // tip, which is otherwise a rare path.
    // Branch predictor hints are kept in comments on some branches for when
    // the end-of-string check is added separately.

    while (dest != end) {
        if (bb_eos(&reader))
            return dest - begin;

        uint8_t octet = bb_peek(&reader);

        struct fast_find_symbol sym = shortbits0[octet];
        if (LIKELY(sym.octet != SENTINEL)) {
            *dest = sym.octet;
            ++dest;
            bb_next(&reader, sym.bits);
            continue;
        }

        bb_next(&reader, 8);

        if (octet == 0xfe) {
            // Only 4 branches off 0xfe. All 10-bit codes.
            octet = bb_peek(&reader);
            const uint8_t octets[] = { '!', '"', '(', ')' };
            *dest = octets[octet >> 6];
            ++dest;
            bb_next(&reader, 2);
            continue;
        }

        octet = bb_peek(&reader);
        sym = shortbits1_ff[octet];

        if (sym.octet != SENTINEL) { // LIKELY
            *dest = sym.octet;
            ++dest;
            // TODO: Store post-modulo bit length in lookup table
            bb_next(&reader, sym.bits % 8);
            continue;
        }

        bb_next(&reader, 8);

        // Two branches again; fe & ff
        // fe table only has 15 symbols of 19-21 bits total length
        if (octet == 0xfe) {
            octet = bb_peek(&reader);
            sym = shortbits2_fffe[octet];
            // All values in this table terminate on a valid octet;
            // there are no sentinels.
            *dest = sym.octet;
            ++dest;
            // TODO: Store post-modulo bit length in lookup table
            bb_next(&reader, sym.bits % 8);
            continue;
        }

        // else: octet == ff

        octet = bb_peek(&reader);
        sym = shortbits2_ffff[octet];

        if (sym.octet != SENTINEL) { // LIKELY
            *dest = sym.octet;
            ++dest;
            // TODO: Store post-subtraction bit length in lookup table
            // This table has 24-bit symbols, so it must not use modulus.
            bb_next(&reader, sym.bits - 16);
            continue;
        }

        bb_next(&reader, 8);

        if (octet != 0xfe && octet != 0xff) { // LIKELY
            sym = shortbits23[(uint8_t)(octet << 4) | bb_peek(&reader) >> 4];
            *dest = sym.octet;
            ++dest;

            // TODO: Store post-subtraction bit length in lookup table
            // This table has values from 25-27 so modulus is OK
            bb_next(&reader, sym.bits % 8);
            continue;
        }

        // See the documentation on the shortbits3 table
        // tldr: It's 7 bits (a septet).
        octet = ((octet << 6) & 64) | (bb_peek(&reader) >> 2);
        sym = shortbits3[octet];

        // This far down the tree we're much more likely to have reached
        // end-of-string than to be finding a rare Huffman code.
        // However, once there's a separate end-of-string check, this becomes
        // LIKELY because nobody would normally encode the entire EOS symbol.
        if (sym.octet != SENTINEL) { // LIKELY
            *dest = sym.octet;
            ++dest;
            // TODO: Store post-subtraction bit length in lookup table
            // This is also safe for modulus; ranges are 27-30 bits.
            bb_next(&reader, sym.bits % 8);
            continue;
        }

        // sym.octet == SENTINEL; end-of-string reached.
        // (This doesn't communicate how many bytes of input were used, but
        // HPACK uses length-prefixing anyway so we don't need to know.)
        return dest - begin;
    }

    return bb_eos(&reader) ? dest - begin : -1; // destination buffer too small
}

static ssize_t string_decode_common(
        const uint8_t *buf,
        size_t buflen,
        uint8_t **destp,
        size_t *destlenp)
{
    if (buflen < 1)
        return -1;

    const bool huff = (buf[0] & 0x80);

    uintmax_t number = 0;
    ssize_t len = decode_number(buf, len, 7, &number);
    if (len < 1) {
        return -1;
    }

    if (buflen - len < number)
        return -1; // input buffer too short

    if (*destp == NULL) {
        // Allocate.
        //
        // Decoded string should be at most 8÷5+1 the length of the encoded
        // buffer.
        if (huff) {
            // Don't care about integer overflow; the buffer will just be too
            // short and the decode will fail. If it overflows it's an
            // unrealistically large input anyway.
            *destlenp = number * 8 / 5 + 1;
        } else {
            *destlenp = number;
        }

        *destp = malloc(*destlenp);

        if (*destp == NULL) {
            *destlenp = 0;
            return -1; // ENOMEM
        }
    } else {
        if (destlen < number)
            return -1; // output buffer too short
    }

    const uint8_t *string_start = buf + len;
    size_t string_buf_len = buflen - len;

    if (huff)
        return huffman_decode(string_start, string_buf_len, 8, dest, destlen);

    // raw octets
    memcpy(dest, string_start, number);
    return len + number;
}

ssize_t string_decode(
        const uint8_t *buf,
        size_t buflen,
        uint8_t *dest,
        size_t destlen)
{
    return string_decode_common(buf, buflen, &dest, &destlen);
}

ssize_t string_decode_alloc(
        const uint8_t *buf,
        size_t buflen,
        uint8_t **destp,
        size_t *destlenp)
{
    if (*destp) {
        free(*destp);
        *destp = NULL;
    }

    *destlenp = 0;

    return string_decode_common(buf, buflen, destp, destlenp);
}
